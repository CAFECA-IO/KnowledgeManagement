# 智能合約實現的去中心化訂單簿系統

### **引言：去中心化交易的核心挑戰**

傳統金融市場中的訂單簿（Order Book）系統是促進資產交易的核心機制，它高效地匯集買賣雙方的交易意圖，並透過撮合引擎實現價格發現與交易執行。然而，這些系統本質上是中心化的，存在單點故障、數據不透明及潛在的審查風險。隨著區塊鏈技術的興起，去中心化交易所（DEX）旨在克服這些中心化問題，但將複雜的訂單簿功能直接移植到智能合約上，卻面臨著獨特的技術挑戰。

本交易所致力於提供一個透明、高效且安全的去中心化交易環境。為此，我們設計並實現了一套基於智能合約的訂單簿系統，旨在解決現有區塊鏈技術在處理高頻、複雜交易撮合方面的限制，同時保留去中心化的核心優勢。本系統的核心目的在於**撮合買賣雙方不同的期望價格需求，並建立一套機制來找到雙方都認同的交易價格**。這包括精確地**記錄用戶的交易需求**和**高效地撮合這些需求**。

### **智能合約實現訂單簿的固有困難**

在區塊鏈上直接實現一個功能完整且高效的訂單簿系統面臨以下關鍵挑戰：

- **智能合約的執行限制：** 智能合約是「函數式」的，其執行僅限於用戶主動發起交易時的一次性函數呼叫。不同於傳統伺服器能夠持續運行、不停監聽或重複執行撮合邏輯，智能合約無法維持一個常駐服務來主動搜尋撮合條件。此外，每次智能合約的執行都受制於區塊的 Gas Limit，限制了其單次操作的運算步驟和複雜度。

- **高時間複雜度與可擴展性問題：** 一個活躍的訂單簿可能包含數十萬筆待處理的委託單。若每次新訂單進入都需要智能合約從所有現有訂單中逐一比對撮合，其運算量將是巨大的。例如，即使是效率較高的排序演算法（如 Quick Sort 的 O(N log N) 時間複雜度），在數據量龐大時，也會迅速超出智能合約的 Gas 限制。這使得傳統的、需要頻繁排序和大量比對的訂單簿模型難以在鏈上直接實現。

### **我們的創新解決方案**

為克服上述挑戰，本智能合約訂單簿系統採用了結合**優化數據結構**與**混合撮合機制**的創新方法，確保了鏈上交易的高效與去中心化。

**限價單的鏈表（Linked List）優化**

針對用戶提交的限價單，我們採用了鏈表（Linked List）數據結構來高效管理訂單簿。

- **避免複雜排序：** 傳統訂單簿中頻繁的排序操作是鏈上實現的瓶頸。透過鏈表，每當有新訂單掛入時，系統能夠以有限的運算成本，將其精確地插入到預先排序好的位置。這確保了訂單簿始終保持價格有序，避免了在每次交易時執行昂貴的全局排序演算法。

- **高效撮合邏輯：** 由於訂單簿的有序性，在執行撮合操作時，智能合約只需從鏈表的「最優價格」端開始比對，無需遍歷所有訂單。如果最優價格的訂單無法匹配，那麼更差價格的訂單也同樣無法匹配，從而顯著減少了鏈上運算量。

**市價單的自動化做市商（AMM）整合**

對於市價單的快速執行，我們引入了成熟且高效的外部機制——Uniswap 的**自動化做市商（Automated Market Maker, AMM）模式**。

- **解決即時成交需求：** AMM 模式非常適合處理用戶希望以當前市場價格即時成交的市價單。它無需依賴傳統訂單簿的逐一比對，而是透過流動性池中的資產儲備比例來動態決定交易價格。

- **工作原理簡述：** 在 AMM 模式下，流動性提供者向智能合約中的流動性池存入兩種資產，並以此決定初始交易匯率。隨後的交易會根據資產交換量與預設的 AMM 公式動態調整匯率，這自然會產生「滑價」（Slippage）。

**預設的 AMM 公式：**

其中 $x$ 和 $y$ 是池中兩種資產的儲備量，「市價單會造成儲備比例改變，價格依比例動態調整」

```math
x \cdot y = k
```

<img width="1080" height="533" alt="Image" src="https://github.com/user-attachments/assets/8c9172cf-69b9-4a89-8195-ebf3c79a690c" />

ref: [AMM 進化史](https://news.cnyes.com/news/id/4943990)


## **結論與展望**

本智能合約訂單簿系統透過結合鏈表優化與 AMM 整合的策略，有效地解決了在區塊鏈環境中實現傳統訂單簿所面臨的性能和效率挑戰。這不僅確保了交易撮合的透明性與安全性，更為去中心化金融應用開啟了更多可能性。


# Reference

- [智能合約實現的交易所](https://github.com/XPAEXCHANGE/smart-contracts/blob/master/Solidity/Baliv.sol)
- [Uniswap v3 liquidity math](https://atiselsts.github.io/pdfs/uniswap-v3-liquidity-math.pdf)
- [AMM 進化史](https://news.cnyes.com/news/id/4943990)
