# EIP-1559

## 什麼是Ethereum Improvement proposals - 1559

>*Vitalik Buterin: A transaction pricing mechanism that includes fixed-per-block network fee that is burned and dynamically expands/contracts block sizes to deal with transient congestion.*

在2021年8月5日EIP-1559出現以前， 瓦斯費是由市場**競標**而來，每一筆交易可以設定一個用戶願意給付的瓦斯費，當網絡變得繁忙時，也就是有很多交易需要處理的時候，礦工（負責處理交易的節點）會優先處理那些支付更高瓦斯價格的交易。然而，這種競標系統導致不穩定的瓦斯價格，因為用戶需要在每次交易時**猜測**應該支付多少瓦斯費，取決於其他用戶的出價。

EIP-1559（為五個倫敦網路升級提案中其一）宗旨就在於改變現有的瓦斯費計算模式使其可以**調度離尖峰交易量**，並且取代競標模式，在EIP-1559下，瓦斯費將由兩個組成部分組成 - **基礎費(Base Fee)**和**小費(Tips)**。基礎費將是所有用戶都必須支付的標準費用，它將根據網絡流量由網絡計算(但這種計算是可預測的)而得。小費將是用戶可以支付的可選額外費用，以加快他們的交易速度。

	如果上一個區塊剛好為50%滿，基礎費用將保持不變。
	如果上一個區塊為100%滿，基礎費用將在下一個區塊中最多增加12.5%。
	如果上一個區塊超過50%但不滿100%滿，基礎費用將以不到12.5%的幅度增加。
	如果上一個區塊為0%滿 - 也就是空的 - 基礎費用將在下一個區塊中最多減少12.5%。
	如果上一個區塊超過0%但不滿50%滿，基礎費用將以不到12.5%的幅度減少。

EIP-1559還要求網絡**燒毀**用於支付基礎費用的以太幣代幣(Ether Bruning)。這個程序將減少以太幣代幣的總供應量，使以太幣變得更加稀缺，因此更有價值，也能利用這個手段對以太幣的通膨進行控制。而且在EIP-1559之前的礦工由高到低排好了要打包的交易之後，他可以把出價最低的幾筆交易換掉，故意自己製造一些高手續費的無用交易，反正手續費最後都會回到礦工身上，而且墊高最低手續費後，排在前面的交易也要付更多錢給礦工。

所以一旦以太坊實施EIP-1559，希望正常交易處理速度的用戶可以支付基礎費（將其銷毀），而希望更快交易處理速度的用戶可以添加小費（礦工費用），就不用迫使用戶猜測所需費瓦斯費了。

## 交易格式
用了一種新型的 EIP-2718 交易格式，這些參數使用RLP（Recursive Length Prefix）格式進行序列化， 格式如下： 

	0x02 || rlp([chain_id, nonce, max_priority_fee_per_gas, max_fee_per_gas, gas_limit, destination, amount, data, access_list, signature_y_parity, signature_r, signature_s])
 
- Gas 價格已替換為「每種 Gas 的最大優先費」和「每種 Gas 的最大費用」。
- **chain ID是單獨編碼**的，而不是包含在簽名v值中。這實質上以更簡單的實作取代了 EIP-155(v = recid+ chainID*2+ 35)。
- 簽名v值現在是一個簡單的奇偶校驗位元（「簽名 Y 奇偶校驗」），它是 0 或 1，取決於應使用橢圓曲線上的哪個點。

每單位瓦斯的基本費用，它每個區塊都可以根據一個公式上下調整，該公式是父區塊中使用的瓦斯和父區塊的瓦斯目標（瓦斯限制(gas limit)乘以以彈性倍增器(elastic multiplier)）的函數。

該算法導致基本每單位瓦斯的費用在區塊超過瓦斯目標時增加，而在區塊低於瓦斯目標時減少。基本每單位瓦斯費用會被銷毀。交易會指定他們願意支付給礦工的每單位瓦斯的最高費用，以鼓勵他們包括他們的交易（也就是優先費用）。交易還會指定他們願意支付的每單位瓦斯的最高總費用（即：最大費用），該費用包括優先費用和區塊的每單位瓦斯網絡費用（即：基本費用）。該交易將始終支付包括在其所在區塊中的基本每單位瓦斯費用，並且只要兩種費用的總額不超過交易的最高每單位瓦斯費用，它們將支付在交易中設置的優先費用每單位瓦斯。若交易總費用大於最高每單位瓦斯費用的話，交易則將無法被區塊鏈網絡接受和處理。
![](https://blog.bitmex.com/wp-content/uploads/2021/05/Screenshot-2021-05-11-at-13.21.34-1024x512.png)


## Specification

1.As of FORK_BLOCK_NUMBER, a new EIP-2718 transaction is introduced with TransactionType 2.

2.新交易的固有成本是從 EIP-2930 繼承而來的:

	21000 + 16 * non-zero calldata bytes + 4 * zero calldata bytes + 1900 * access list storage key count + 2400 * access list address count

3.此交易的 EIP-2718 TransactionPayload 為:

	rlp([chain_id, nonce, max_priority_fee_per_gas, max_fee_per_gas, gas_limit, destination, amount, data, access_list, signature_y_parity, signature_r, signature_s])

4.此交易中的 signature_y_parity、signature_r 和 signature_s 元素表示對:

	keccak256(0x02 || rlp([chain_id, nonce, max_priority_fee_per_gas, max_fee_per_gas, gas_limit, destination, amount, data, access_list])) 
 的 secp256k1 簽名。

5.交易的 EIP-2718 ReceiptPayload 包括以下參數：

	rlp([status, cumulative_transaction_gas_used, logs_bloom, logs])

## 向後兼容性
傳統的以太坊交易仍然可以正常運行並被包含在區塊中，但它們將無法直接從新的價格系統中受益。這是因為從傳統交易升級到新交易將導致傳統交易的 gas_price 完全被 base_fee_per_gas 和 priority_fee_per_gas 消耗。
- Block Hash Changing
  
Since Block Hash is Changing 所有驗證區塊或使用區塊哈希驗證區塊內容的應用程序將需要適應新的數據結構（增加了一個額外的項目）。如果只取區塊標頭字節並對其進行哈希運算，仍然可以正確獲得哈希值，但如果從其組成元素構建區塊標頭，則需要在末尾添加新的元素。
- Gas Price
  
在此變更之前，GASPRICE 同時代表了簽名者每個 gas 單位支付的以太幣，以及礦工每個 gas 單位獲得的以太幣。從這次變更開始，GASPRICE 現在僅代表了簽名者每個 gas 單位支付的以太幣，礦工獲得的交易費用不再可以直接在 EVM 中訪問，這麼做可以使用戶所需的費用變得更清晰。

## Security Considerations
### 增加最大區塊大小/複雜性
EIP-1559將增加最大區塊大小，這可能會引起問題，如果礦工無法快速處理一個區塊，那麼他們將被迫挖掘一個空區塊。隨著時間的推移，平均區塊大小應該保持與沒有這個提案相同，所以這只是一個短期區塊大小暴增的問題。有可能一個或多個客戶端無法很好地處理短期區塊大小暴增，導致錯誤（例如內存不足或類似的錯誤），客戶端實現應確保它們的客戶端能夠適當地處理個別區塊，直到達到最大大小。

### 交易排序
由於大多數人不再基於優先費用競爭，而是使用基準費用來確保被包含在內，交易的排序現在取決於個別客戶端的內部實現細節，例如它們如何在內存中存儲交易。建議將具有相同優先費用的交易按照接收交易的時間進行排序，以保護網絡免受垃圾攻擊，其中攻擊者將大量交易放入待處理池，以確保至少有一個交易處於有利位置。礦工仍應根據自私挖掘的角度選擇高優先費用的交易，而不是低優先費用的交易。

### 礦工挖掘空區塊
有可能礦工會挖掘空區塊，直到基礎費用非常低，然後開始挖掘半滿區塊，並重新按優先費用排序交易。雖然這種攻擊是可能的，但它並不是一個特別穩定的均衡狀態，只要挖礦是去中心化的。任何從這種策略中叛逃的礦工將比參與攻擊的礦工更有利可圖，即使在基礎費用達到0之後也是如此。由於任何礦工都可以匿名叛逃，而且無法證明特定礦工叛逃，所以唯一可行的執行這種攻擊的方式是控制50%或更多的算力。如果攻擊者擁有確切的50%算力，他們將不會從優先費用中獲得以太幣，而叛逃者將從優先費用中獲得兩倍的以太幣。對於攻擊者要實現盈利，他們需要擁有50%以上的算力，這意味著他們可以執行雙重支付攻擊，或者簡單地忽略任何其他礦工，這是一種更有利可圖的策略。

### ETH銷毀將排除固定供應
通過銷毀基礎費用，我們無法再保證以太幣供應的固定性。這可能導致經濟不穩定，因為長期以來以太幣的供應將不再保持恆定。儘管這是一個有效的擔憂，但很難量化其影響。如果銷毀的基礎費用多於挖礦獎勵所產生的，那麼ETH將是通縮的；如果挖礦獎勵多於銷毀的，那麼ETH將是通膨的。由於我們無法控制用戶對區塊空間的需求，所以我們現在無法斷言ETH最終會是通膨還是通縮，因此這個變化使核心開發者對以太的長期供應失去了一些控制。

### 可能集中化
Sergio Demian Lerner提出擔憂，EIP-1559可能導致礦池在網絡中佔主導地位，形成集中化現象。在減少礦工收入模型下，小型礦工可能難以競爭，進一步集中化可能威脅到網絡的去中心化性質。

## News about EIP-1559
1. Ether Burn Hits $1.1B After EIP-1559 Activation, by JACQUELYN MELINEK / SEPTEMBER 29, 2021
根據超音波貨幣追蹤器的數據，截至本文發佈時，大約 386,466 ETH（約 11 億美元）已被燒毀，8 月 5 日實施 EIP-1559 以來，已燒毀價值超過 10 億美元的以太幣，達到了加密貨幣的另一個里程碑。以太坊稍微處於通縮期，但一旦以太坊區塊鏈在 2022 年轉變為權益證明系統，成為以太坊 2.0 的一部分，預計將更頻繁地面臨更大的通縮期。
2. EIP-1559實施365天：NFT協議燒幣量大於DeFi, by Elponcho / August 5, 2022
根據 ultrasound.money，365 天以來燒毀了約 260 萬個以太幣，基於 PoW 共識發行了 550 萬個以太幣，整體來說，為以太幣總流通量帶來 2.4% 的年增幅，365 天以來，每分鐘燒毀 4.89 個以太幣被燒毀，抵銷發行 0.47 x。在不同的類型交易中，NFT 活動所銷毀的以太幣，勝過 DeFi 活動，也彰顯了過去一年 NFT 的興盛與 DeFi 的降溫，其次為套利活動 MEV，以及其他活動。

## EIP-1559 raw transaction sample and algorithm
### 假設我們有一個 EIP-1559 raw transaction sample:
 	0x02f902fa0181b483a6792e850244ddce8e83045ee9943fc91a3afd70395cd496c647d5a6cc9d4b2b7fad8802c68af0bb140000b902843593564c000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000006508457f00000000000000000000000000000000000000000000000000000000000000020b080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000002c68af0bb1400000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000002c68af0bb140000000000000000000000000000000000000000000000001886271c2fb90c220a4d00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000003850952491606a0e420eb929b1a2e1a450d013f1c001a08b50ee3e376edb0fc0719ecb19a38dd7558285ba61b15c30083369bb76bfb393a069dc859312719259201ffae0c78208abc1b4e93ed05fd782f754dbe9eec75231

解析後得到 JSON object：

	{
	  "chainId": "1",
	  "type": "EIP-1559",
	  "valid": true,
	  "hash": "0x9d0de6855390ff87e9fe9ca8a8e07e6a8819f29531ea69dc701f96268080440d",
	  "nonce": "180",
	  "gasLimit": "286441",
	  "maxFeePerGas": "9745321614",
	  "maxPriorityFeePerGas": "10909998",
	  "from": "0x7C71e3C2dC48557336961e0adc390164C8b045b6",
	  "to": "0x3fc91a3afd70395cd496c647d5a6cc9d4b2b7fad",
	  "publicKey": "0x042e53305a01238bbb049d4f4d4c06b9aabaf42297bb2368f9263fb2e155fd9fce02bdd0e0e1a97632e4da7e11605423563a70fe78c146ab4ee89f234204f60d0c",
	  "v": "01",
	  "r": "8b50ee3e376edb0fc0719ecb19a38dd7558285ba61b15c30083369bb76bfb393",
	  "s": "69dc859312719259201ffae0c78208abc1b4e93ed05fd782f754dbe9eec75231",
	  "value": "200000000000000000",
	  "data": "0x3593564c000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000006508457f00000000000000000000000000000000000000000000000000000000000000020b080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000002c68af0bb1400000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000002c68af0bb140000000000000000000000000000000000000000000000001886271c2fb90c220a4d00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000003850952491606a0e420eb929b1a2e1a450d013f1",
	  "functionHash": "0x3593564c",
	  "possibleFunctions": [
	    {
	      "definition": "execute(bytes,bytes[],uint256)",
	      "decodedInputs": [
	        "0b08",
	        [
	          "000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000002c68af0bb140000",
	          "000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000002c68af0bb140000000000000000000000000000000000000000000000001886271c2fb90c220a4d00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000003850952491606a0e420eb929b1a2e1a450d013f1"
	        ],
	        "1695040895"
	      ]
	    }
	  ]
   ### 解析內容
   1. "chianId:1" 代表以太坊主網（補充："3"代表Ropsten使用PoW算法, "4"代表Rinkeby是以太坊的PoA的測試網路, "42"代表Kovan使用Clique算法, "100"代表XDai提供快速的交易, 其他chainID可以在[chainlist.org](https://chainlist.org/)查找）
   2. "Type:EIP-1559": 代表交易類型
   3. "valid:true": 表示交易有效且可以被處理
   4. "hash": 是一個唯一標識符，16進制字串，類似於收據，用作交易已驗證並添加到區塊鏈的證據。在許多情況下，需要hash來定位資金。
   5. "nonce": 是發送者地址的計數，確保交易按正確的順序處理並防止雙重支付，此交易來說，這是使用者錢包的第180次交易
   6. "gaslimit": 用於此交易的最大Gas限制
   7. "maxFeePerGas": 告知以太坊區塊鏈用戶願意花費的最大金額
   8. "maxPriorityFeePerGas" 用戶願意支付的最高小費金額
   9. "from","to": 使用者與接收者的以太坊地址
   10. "publicKey": 以太坊公鑰是橢圓曲線上滿足橢圓曲線方程式的一組 x 和 y 座標。它是透過使用橢圓曲線乘法從私鑰產生的兩個數字得出的。這個過程是不可逆的，這意味著私鑰不能從公鑰推導出來。請參見演算法章節
   12. "v","r","s": r和s是 ECDSA 簽名的輸出， v是恢復 ID
   13. "value": 以Wei為單位表示的以太幣金額。在此交易中，它是200,000,000,000,000,000 Wei，相當於0.2以太幣
   14. "data": 函數調用及其參數
   15. "functionHash": data字段串調用的函數的hash值
   16. "possibleFunctions"：呼叫了名為『execute(bytes,bytes[],uint256)』的函數，並提供了特定的解碼輸入(decodedInputs)
   ### 演算法
   1. RLP:
   2. Secp256k1:
   3. public key 產生：
   4. hash 產生：
   5. v,r,s:
   6. 密碼學：
## 常見問題


## 參考：
	1. https://github.com/ethereum/EIPs/blob/master/EIPS/eip-1559.md
	2. https://blockworks.co/news/ether-burn-hits-1-1b-after-eip-1559-activation
	3. https://abmedia.io/20220805-eip-1559-365-days
	4. https://consensys.net/blog/quorum/what-is-eip-1559-how-will-it-change-ethereum/
	5. https://morten.dev/posts/new-transaction-types-on-ethereum
	6. https://blog.bitmex.com/zh_cn-breaking-down-the-fee-market-eip-1559/
	7. https://notes.ethereum.org/@vbuterin/eip-1559-faq





