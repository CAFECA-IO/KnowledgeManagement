## ERC-4337 簡介
ERC-4337（透過入口點合約規範(`Entry Point Contract specification`)的賬戶抽象化）是一個旨在使用入口點合約來實現賬戶抽象化的規範，而非修改共識層本身的邏輯，ERC-4337 在更高一級的系統中復製了交易內存池的功能。用戶發送的 `UserOperation` 對象將用戶的意圖連同簽名和其他用於驗證的數據打包在一起。礦工或者使用諸如 `Flashbots` 之類的服務的 `Bundler`（打包者）可以將一組 `UserOperation` 對象打包成單一的「`bundle transaction`(綑綁交易)」，然後將其納入以太坊區塊中。

ERC-4337 還引入了一種支付主機制(`paymaster mechanism`)，該機制可以使用戶使用 `ERC-20` 代幣（例如 USDC）而不是 ETH 來支付燃氣費，允許第三方完全以去中心化的方式贊助他們的燃氣費。

ERC-4337 目前仍處於草案階段，尚未最終確定。然而，由於 ERC-4337 不會改變共識層，因此已經有幾個實現可用，如 eth-infinitsm 和 Stackup。

ERC-4337 實現賬戶抽象化和用戶友好的交易簽名流程的關鍵在於它將傳統的基於私鑰的錢包管理機制轉變為智能合約驅動的過程。以下是它是如何實現這些特點的：

1. **賬戶抽象化**
   - **智能合約賬戶**: 在 ERC-4337 標準中，用戶的加密資產和相關操作都是通過智能合約來管理的。這些合約賬戶代替了傳統的基於私鑰的地址系統。
   - **去除私鑰依賴**: 用戶不再需要管理私鑰來執行交易。相反，他們的身份和權限是通過合約邏輯來定義和控制的。
   - **多重簽名和安全控制**: 合約可以設計成支持多重簽名，或包含其他安全措施，如時間鎖、限額等，增強安全性和靈活性。

2. **用戶友好的交易簽名流程**
   - **簡化的交易過程**: 用戶進行交易時，不需要直接與區塊鏈交互或處理複雜的簽名過程。他們只需通過用戶界面發起交易請求。
   - **元交易（Meta-transactions）**: ERC-4337 允許所謂的元交易，這意味著用戶可以發起交易而不必直接支付礦工費用。費用可以由第三方支付，或通過合約中的資金來支付。
   - **委託簽名**: 用戶可以委託可信的第三方對交易進行簽名，這提高了使用的便利性，特別是對於非技術用戶。

3. **透明與互動性**
   - **使用界面友好**: 鑒於所有交易都是通過合約來執行，開發者可以為這些智能合約創建更直觀、更用戶友好的界面。
   - **與DApps的無縫集成**: 這種賬戶抽象化使得與各種去中心化應用（DApps）的集成更加簡單和自然，提供了更流暢的用戶體驗。

## ERC-4337 架構

在 ERC-4337 架構中，有幾個主要的組件：`UserOperation`、打包者（`Bundler`）、入口點合約（`EntryPoint Contract`）、賬戶合約（`Account Contract`）、賬戶工廠合約（`Account Factory Contract`）和主支付合約（`Paymaster Contract`）。

1. **UserOperation**
   - 是 `pseudo-transaction objects`(擬交易物件)，用於執行合約賬戶的交易。這些由去中心化應用（DApp）創建。
   - 錢包應能將普通交易轉換為 `UserOperation`，這樣 DApp 的前端就不需要改變任何內容就可以支持 ERC-4337。

2. **Bundler（打包者）**
   - Bundler（打包者） 是將來自內存池的 `UserOperation` 打包並發送到區塊鏈上 `EntryPoint contract`（入口點合約）的行為者。

3. **EntryPoint contract（入口點合約）**
   - 這是一個智能合約，處理交易的驗證和執行邏輯。

4. **Account Contract（賬戶合約）**
   - 用戶擁有的智能合約賬戶。
   - 錢包開發者需要實現至少兩個自定義功能 - 一個用於驗證簽名，另一個用於處理交易。

5. **Factory Contract工廠合約（工廠合約）**
   - 首次使用錢包時，`UserOperation` 的 `initCode` 字段用於指定創建智能合約錢包。這與錢包的第一個實際操作（在同一個 `UserOperation` 中）同時使用。
   - 因此，錢包開發者還需要實現賬戶工廠合約（例如：[`BLSAccountFactory.sol`](https://github.com/eth-infinitism/account-abstraction/blob/develop/contracts/samples/bls/BLSAccountFactory.sol)）。創建新錢包應使用 CREATE2 方法以確保生成地址的確定性。

6. **Paymaster Contract（主支付合約）**
   - 可選的智能合約賬戶，可以為賬戶合約贊助燃氣費，或允許其擁有者使用 ERC-20 代幣而非 ETH 支付這些費用。

### 交易的典型生命周期如下：
![image](https://github.com/CAFECA-IO/KnowledgeManagement/assets/17249354/589d472e-ddbe-40e1-9e80-ee9f19e8cc48)
[圖片來源](https://www.erc4337.io/docs/understanding-ERC-4337/architecture)

- 用戶透過其錢包或 DApp 創建一個 UserOperation。
- 這個 UserOperation 被發送到內存池，等待Bundler（打包者）處理。
- Bundler（打包者）從內存池選擇 UserOperation，將它們打包成一個bundle transaction(綑綁交易)，並發送到EntryPoint contract（入口點合約）。
- EntryPoint contract（入口點合約）檢查這些 UserOperation 的有效性和簽名，並根據其內容執行相應的賬戶合約。
- 在這個過程中，Paymaster Contract（主支付合約）可以用於支付或贊助這些操作的燃氣費。

這個架構的目標是為以太坊用戶提供更加靈活和用戶友好的交易方式，同時保持去中心化和安全性。

### UserOperation
在 ERC-4337 架構中，`UserOperation` 是一個圍繞智能合約賬戶執行行動的偽交易對象。它與常規交易類型有所不同，具有以下特定的字段和特性：

1. **UserOperation 字段**
   - **sender (地址型)**: 智能合約賬戶的地址。
   - **nonce (uint256型)**: 防重放保護；同時用作首次創建賬戶時的鹽值。
   - **initCode (字節型)**: 如果賬戶尚未在鏈上，則用於部署賬戶的代碼。
   - **callData (字節型)**: 傳遞給發送者執行的數據。
   - **callGasLimit (uint256型)**: 執行階段的燃氣限制。
   - **verificationGasLimit (uint256型)**: 驗證階段的燃氣限制。
   - **preVerificationGas (uint256型)**: 補償打包者的燃氣費。
   - **maxFeePerGas (uint256型)**: 每單位燃氣的最大費用（類似於 EIP-1559 的 max_fee_per_gas）。
   - **maxPriorityFeePerGas (uint256型)**: 每單位燃氣的最大優先費用（類似於 EIP-1559 的 max_priority_fee_per_gas）。
   - **paymasterAndData (字節型)**: Paymaster Contract（主支付合約）地址和用於驗證和執行的額外數據（自我贊助的交易為空）。
   - **signature (字節型)**: 用於驗證 UserOperation 以及在驗證過程中使用的 nonce。

2. **UserOperation 內存池**
   - UserOperation 不會被發送到傳統的公共內存池，該內存池托管著等待執行的由外部帳戶（Externally Owned Accounts, EOAs）直接發起的交易。相反，它們將被發送到 UserOperation 內存池：一個專門為 UserOperation 設計的高級內存池。

3. **打包者（Bundler）**
   - 打包者監聽 UserOperation 內存池，將多個 UserOperation 打包成一個「經典」交易。他們首先使用相關的入口點方法驗證 UserOperation 的有效性。然後，打包者將將這個多 UserOperation 交易提交至以太坊網絡。重要的是，這個交易不是發送到常規的公共內存池，而是直接被包含在他們提議給網絡的下一個區塊中。打包者可能是區塊建造者（即那些有能力直接向以太坊主鏈提交新區塊的實體）本身，或者是與區塊建造者合作的獨立實體。他們通過打包和提交這些交易來參與區塊鏈的維護和擴展。

這種機制讓 UserOperation 可以更靈活地處理和執行，同時避免了傳統交易流程中可能出現的延遲和擁堵。

### 入口點合約（EntryPoint Contract）
入口點合約（EntryPoint Contract）在 ERC-4337 架構中是一個關鍵組件，並且通常與其他幾個合約（如 StakeManager）一起作為`Singleton`存在。其主要功能和特點包括：在 ERC-4337 架構中是一個關鍵組件，並且通常與其他幾個合約（如 StakeManager）一起作為單例存在。其主要功能和特點包括：

1. **單例合約**：
   - 入口點合約是一個`Singleton`，意味著在每個鏈上只應存在一個實例。這樣做是為了確保統一性和一致性，並且避免了複雜性和潛在的安全風險，這些可能會隨著多個實例的出現而增加。

2. **驗證和執行 UserOperation 捆綁**：
   - 入口點合約的主要職責是驗證並執行發送到它的 UserOperation 捆綁。它會檢查每個 UserOperation 的有效性，並根據其內容進行適當的處理。

3. **簡化智能合約錢包的邏輯**：
   - 使用單一的入口點合約簡化了智能合約錢包的邏輯。這確保了用於確保安全所需的更複雜的智能合約功能經過充分的測試和驗證。這樣，錢包可以主要專注於核心的智能賬戶功能（例如簽名驗證規則）。

4. **白名單入口點合約地址**：
   - 打包者和客戶端應該將他們支持的入口點合約地址列入白名單。這樣做有助於確保他們只與那些被認為是安全且可靠的合約進行交互，從而降低了與未經驗證或不可信合約交互的風險。

總之，入口點合約是 ERC-4337 生態系統中的中樞，它不僅確保了交易的順利執行，而且為整個系統提供了一個穩定和可靠的基礎。這種設計使得智能合約錢包的開發變得更為簡單和安全，同時保持了系統的整體效率和可擴展性。

### 賬戶合約（Account Contract）
在以太坊的外部擁有賬戶（EOAs）中，地址在所有 EVM 網絡上都是一致的。只要用戶擁有私鑰，他們就可以在任何網絡上訪問相同的地址。理想情況下，我們希望在合約賬戶中創建相同的用戶體驗。

用戶應該能夠確定地知道他們的賬戶地址，在每個 EVM 網絡上保持一致，無論賬戶是否已部署。這意味著他們可以生成一個賬戶並開始向其發送資金，並且知道只要他們擁有正確的驗證方法，就能隨時控制這些資金。

ERC-4337 通過使用 CREATE2 操作碼和單例工廠（[Singleton Factory](https://eips.ethereum.org/EIPS/eip-2470)） - 即賬戶工廠合約（[Account Factory Contract](https://www.erc4337.io/docs/understanding-ERC-4337/account-factory-contract.md)）來實現這一點。例如，您可以使用 ethers.js 來計算 CREATE2 地址：

```javascript
const accountAddress = ethers.utils.getCreate2Address(
  fromAddress,
  salt,
  initCodeHash
);
```

合約地址由 `fromAddress`、`salt` 和 `initCodeHash` 確定。

- **fromAddress**: fromAddress 是單例工廠的地址。這個工廠接收 salt 和 initCode 作為輸入，並使用 CREATE2 將合約部署到鏈上。

- **salt**: 對於 ERC-4337 賬戶，salt 參數是第一個 nonce 值。這很可能是 0。

- **initCodeHash**: UserOperation 中傳遞的 initCode 是用於初始化它的智能合約代碼和參數。它使用 keccak256 哈希算法來派生 initCodeHash。

由於賬戶工廠合約地址在每個鏈上都是相同的，我們可以依靠它也在所有網絡上使用同一地址部署我們的智能合約代碼。

#### 驗證和授權

##### Nonces 和重放保護
在 ERC-4337 架構中，nonce 用於防止重放攻擊，確保每個交易只能被執行一次。Nonce 是每個交易的唯一標識符，隨著每次成功的交易而遞增。這種機制確保了交易的唯一性和安全性。

通過結合 CREATE2 和 nonce 的使用，ERC-4337 為用戶提供了一種安全且一致的方式來管理他們的賬戶，無論他們在哪個 EVM 兼容的鏈上操作。这种方法提高了用戶體驗的連貫性及安全性，同時保持了區塊鏈環境的去中心化特性。

### 打包者（Bundler）
打包者是核心基礎設施組件，允許在任何 EVM 網絡上實現賬戶抽象化，而無需對協議進行任何更改。它的目的是處理新的 UserOperation 內存池，並確保交易被上鏈。

#### 安全考慮

打包者的主要工作之一是遵守ERC 規範，以防止所有可能的 DoS 攻擊向量。這些包括從確保 UserOperation 在結構上是健全的基本常識檢查，到更深入地追踪被禁止的操作碼和存儲訪問，以確保一旦提交到網絡，捆綁包無法被審查。

類似於以太坊客戶端，所有打包者實現都預計將通過測試套件來確保它們的合規性，並且不會破壞內存池的完整性。Yoav Weiss 寫了一篇[文章](https://notes.ethereum.org/@yoav/unified-erc-4337-mempool)解釋這一點的重要性。

#### UserOperation 內存池

EIP-4337 的標準內存池是去中心化的，由一個無需許可的 P2P 網絡組成，該網絡由獨立的打包者組成。這種架構確保了整個系統的去中心化特性，並提供了一個更開放、更可靠的交易處理環境。打包者在這個網絡中扮演著關鍵角色，他們確保 UserOperation 的有效性和安全性，同時保持整個系統的流暢和有效運作。

### Paymaster Contract（主支付合約）
使用外部帳戶（Externally Owned Accounts, EOAs）的用戶體驗之所以如此困難的主要原因之一是，錢包擁有者需要找到一種方法來獲得一些 ETH，然後才能在鏈上進行任何操作。

通過Paymaster Contract（主支付合約），ERC-4337 允許完全抽象化燃氣費支付，這意味著錢包擁有者以外的人可以支付燃氣費。

燃氣費抽象化提供了諸多好處，例如：

1. **降低進入門檻**：在進行鏈上操作之前需要獲得 ETH，為那些不熟悉加密貨幣的用戶創建了顯著的摩擦點。

2. **提高用戶體驗**：用戶在使用 Web2 應用時不需要支付 AWS 費用，因此對他們來說，使用去中心化應用（DApps）並支付燃氣費可能感到陌生和不合理。Paymaster Contract（主支付合約允許 DApps 贊助這些費用。或者，DApps 可以允許用戶使用 ETH 以外的某種 ERC-20 代幣支付燃氣費，例如使用 USDC。

3. **保護隱私**：用戶可以與他們賬戶中的資產互動（例如，領取的代幣），無需通過從另一個經過 KYC 的錢包或中心化交易所（CEX）發送 ETH 來支付燃氣費而暴露自己的身份。

總的來說，ERC-4337 通過Paymaster Contract（主支付合約）為用戶提供了更加友好的交易方式，允許他們在不直接持有或使用 ETH 的情況下參與到以太坊網絡的各種活動中。這種方法不僅降低了進入門檻，還改善了用戶的隱私保護，使得使用 DApps 變得更加親民和便利。

### wallet
為了支持 ERC-4337，錢包必須實現一個智能合約，該合約需要具有兩個功能：

1. **validateUserOp**：
   - 此功能接受 UserOperation 作為輸入。它的主要目的是驗證 UserOperation 上的簽名和 nonce，如果驗證成功，支付費用並遞增 nonce；如果驗證失敗，則拋出異常。
   - 這個功能確保了 UserOperation 的合法性和安全性，是賬戶合約的重要組成部分，確保只有合法的操作能夠被執行。

2. **操作執行功能（op execution function）**：
   - 這個功能解釋 calldata 作為錢包執行操作的指令。該功能如何解釋 calldata 以及隨之而來的行動是完全開放的。然而，最常見的行為預期會是解析 calldata 作為指令，讓錢包進行一個或多個調用。
   - 這使得賬戶合約能夠靈活地處理各種交易和指令，從而提高了錢包的功能性和適應性。

ERC-4337 核心團隊已經實現了 [SimpleAccount.sol](https://github.com/eth-infinitism/account-abstraction/blob/develop/contracts/samples/SimpleAccount.sol)，這是一個樣本最小賬戶，擴展了 [BaseAccount.sol](https://github.com/eth-infinitism/account-abstraction/blob/develop/contracts/core/BaseAccount.sol)，後者實現了 [IAccount](https://github.com/eth-infinitism/account-abstraction/blob/develop/contracts/interfaces/IAccount.sol)接口。這些實現提供了對於如何構建符合 ERC-4337 標準的賬戶合約的參考模板，幫助錢包開發者更容易地整合和適應這一新標準。通过这种方式，ERC-4337 意图在不改變現有以太坊協議的情况下，為用户提供更加靈活和高效的交易體驗。


## ERC-4337 應用場景
   - **資產管理**: 為用戶提供了更安全、更方便的資產管理方式。
   - **去中心化應用（DApps）**: 能夠與各種 DApps 緊密集成，提高其使用效率和安全性。
   - **企業解決方案**: 對於企業來說，可以利用此標準來實現更安全的資產管理和交易系統。

## ERC-4337 安全性與風險
   - **安全優勢**: 由於去除了傳統私鑰的依賴，降低了密鑰丟失或被竊的風險。
   - **風險考量**: 如同所有區塊鏈技術，仍存在智能合約的漏洞風險，需要持續的審計和更新。

## ERC-4337 解決的問題
- **提高安全性**: 通過智能合約實現賬戶管理，用戶可以實施更複雜的安全措施，如多因素認證和自動化交易監控，顯著降低了安全風險。
- **降低操作複雜度**: ERC-4337減少了用戶需要直接管理的技術細節，如私鑰的保管和交易的簽名過程，從而降低了用戶操作的複雜度。
- **加速交易**: 由於交易過程的簡化，用戶可以更快速地完成交易，這對於那些需要快速反應的應用場景特別有用，如去中心化金融(DeFi)。

##  ERC-4337 實施和影響
### 對開發者的影響
1. **更廣泛的創新空間**：ERC-4337為開發者提供了更多的靈活性來設計和實現新型的智能合約和去中心化應用（DApps）。這可能會激發新的創意，導致更多創新和功能豐富的應用的出現。
2. **降低開發門檻**：由於ERC-4337提供了更簡化的交易和賬戶管理過程，開發者可以更輕鬆地實現複雜的功能，無需擔心過度複雜的用戶端交互。
3. **提高安全性**：透過允許更複雜的安全措施，如多重簽名和自動交易審核，開發者可以為他們的應用創建更安全的架構。

### 對用戶的影響
1. **提升用戶體驗**：ERC-4337的簡化交易流程將大幅改善普通用戶的體驗。用戶可以更輕鬆地進行交易，無需擔心複雜的私鑰管理和簽名過程。
2. **增強安全性和控制權**：用戶能夠利用智能合約設置安全措施，如多重簽名，從而提高他們資產的安全性。同時，他們對自己的賬戶有更多的控制權。
3. **降低進入門檻**：對於新用戶來說，由於交易過程更為直觀和簡單，他們將更容易進入和使用以太坊生態系統。

#### 總體影響
- **生態系統的成長與創新**：ERC-4337的實施可能會促進整個以太坊生態系統的成長，吸引更多開發者和用戶加入。隨著生態系統的擴大，我們可能會看到更多創新和多樣化的DApps的出現。
- **提高整體安全性**：通過使安全措施更容易實施，整個生態系統的安全水平可能會提高，從而增加用戶對以太坊平台的信任。
- **促進主流採納**：隨著用戶體驗的改善和安全性的提高，以太坊和其相關的應用可能會吸引更廣泛的主流用戶群。

## 總結
透過這些核心特點，ERC-4337應對了當前以太坊生態系統中的主要挑戰，即提高用戶友好性和安全性，同時保持了足夠的靈活性和可擴展性。這不僅對普通用戶有利，也對於開發者來說，意味著有更多的可能性來創建創新和安全的應用。

## 參考文件
- [ERC-4337](https://www.erc4337.io/)
